#summary Mission scripts
#labels Featured

= Mission scripts =

Missions can be easily extended with custom scripts to add special events to them. Each missions script is located in `\Maps\map_name\map_name.script` file, which can be opened in any plain text editor (e.g. Notepad). Scripts are written in PascalScript language (syntax is very similar to usual Pascal).

Script has 3 ways of interacting with the game - *Events*, *States* and *Actions*. Events get called by the game when they happen. States are values that can be queried from the game. Actions are way to tell the game what to do. Scripts get verified on mission load and any errors are output in a message to a player.

Script file consists of several parts:

{{{
//Global variables section, accessible from any place in the script and stored in game memory
var
  I: Integer; //variable number
  A: array [0..3] of Boolean; //array of 4 booleans accessible as A[0], A[1] etc.

//Event handler, when the event happens ingame this function gets called
procedure OnHouseBuilt(..); //Ecah event has different input parameters list
var //Local variables, they exist only within this procedure
  L: Integer; //variable number 
begin
  //Event code
  L := 7; //assignment of number to a variable
  Actions.ShowMsg(0,L); //Calling a games action with 2 parameters: 0 and L
end;

//Main section which gets executed each game tick
begin
  //Code here
  if States.GameTime = 60 then //Check game time and show a message
    Actions.ShowMsg(0,3);
end. //script must end with a stop sign .
}}}

Here is Battle Tutorial script explained:

{{{
procedure OnPlayerDefeated(aIndex: Integer);
begin
  if aIndex = 2 then Actions.ShowMsg(0, 2);
  if aIndex = 3 then Actions.ShowMsg(0, 3);
  if aIndex = 4 then Actions.ShowMsg(0, 4);
end;

begin
  if States.GameTime = 20 then 
    Actions.ShowMsg(0, 1);
end.
}}}

Above line means that when PlayerDefeated event comes from the game, we check the index of the player that was defeated (aIndex) and issue a command to show certain message to specified player (0, who is human). Also, each tick we check the games time and on tick 20 we show another message.


==Lookup tables==

 * titles typed in *bold* are implemented in public version.
 * titles typed in normal are implemented, but not in public version.
 * titles typed in _italic_ are planned to be implemented in future.
 * titles typed in ~~crossed out~~ were planned, but were rejected.


===Events===

|| Event || Description || Parameters and types ||
|| `OnPlayerDefeated` || Occurs when certain player has been defeated. Defeat conditions are checked separately by Player AI || aIndex: Integer; //Index of defeated player ||
|| `OnHouseBuilt` || Occurs when player has built a house || aIndex: Integer; //Index of player who built it <br> aHouseType: Integer; //Type of house that was built ||

Events are written in a form procedure *EVENT_NAME(EVENT_PARAMETERS_IN_LINE);* like so:
{{{
procedure OnHouseBuilt(aIndex: Integer; aHouseType: Integer);
begin
  //code
end;
}}}

===States===
All states parameters are numeric and get mapped to unit/house types according to default tables used in DAT scripts.

|| State || Description || Query parameters || Type of return value ||
|| `GameTime` || Get the number of game ticks since mission start || - || Integer ||
|| _`CheckAlliance`_ || Check how player 1 feels towards player 2 (order matters) ||1 - player index <br> 2 - player index || Integer ||
|| _`GetUnitDirection`_ ||
|| _`GetUnitHunger`_ ||
|| _`GetUnitOwner`_ ||
|| _`GetUnitPosition`_ ||
|| _`GetUnitType`_ ||
|| `PlayerDefeated` || See if player was defeated || 1 - player index || Boolean ||

===Actions===
All action parameters are numeric and get mapped to unit/house types according to default tables used in DAT scripts.

|| Action || Description || Parameters (Integer) || Return value ()
|| _`AllianceChange`_ || Change the alliance setting between specified players || 1 - player whose alliance setting will be changed <br> 2 - target player to whom the alliance will be changed <br> 3 - new alliance setting (0 enemy, 1 ally) ||
|| `Defeat` || Proclaims player defeated || 1 - player index ||
|| _`GiveGroup`_ || Give player group of units (citizens or warriors) || 1 - player index <br> 2 - Unit type <br> 3 - location X <br> 4 - location Y <br> 5 - face direction <br> 6 - unit count <br> 7 - units per row || GroupIndex: Integer ||
|| _`GiveUnit`_ || Give player a single citizen || 1 - player index <br> 2 - Unit type <br> 3 - location X <br> 4 - location Y <br> 5 - face direction || UnitIndex: Integer ||
|| _`GiveWares`_ || Adds amount of wares to oldest players Store || 1 - player index <br> 2 - Ware type <br> 3 - Count ||
|| _`LockUnit`_ || Lock out the unit from game updates and make it manually scriptable (?) ||
|| _`SetGroupHunger`_ ||
|| _`SetGroupOrder`_ ||
|| _`SetUnitDirection`_ ||
|| _`SetUnitHunger`_ ||
|| _`SetUnitOwner`_ ||
|| _`SetUnitPosition`_ ||
|| _`ShowCountdown`_ || Display countdown for player || 1. Value to count from ||
|| `ShowMsg` || Displays a message to the player || 1 - player index <br> 2 - Message index in missions LIBX file ||
|| `UnlockHouse` || Explicitly allow player to build houses of specified type || 1 - player index <br> 2 - House type ||
|| _`Victory`_ || Proclaims victory to the player (by making all other players defeated) || 1 - player index ||